MYIP:=$(shell hostname -i)
RUNNING_CONTAINER:=$(shell sudo docker ps|grep "xos"|awk '{print $$NF}')
LAST_CONTAINER=$(shell sudo docker ps -l -q)

cloudlab: common_cloudlab xos

devstack: common_devstack xos

opencloud: common_opencloud xos

xos:
	rm ../../xos_configuration/*
	cp ../common/xos_common_config ../../xos_configuration/
	echo "# Autogenerated -- do not edit" > Dockerfile
	cat ../common/Dockerfile.common Dockerfile.devel >> Dockerfile
	cd ../../..; sudo docker build -t xosproject/xos-devel -f xos/configurations/devel/Dockerfile .
	sudo docker run -d --add-host="ctl:$(MYIP)" -p 9999:8000 xosproject/xos-devel
	bash ../common/wait_for_xos.sh

common_cloudlab:
	make -C ../common -f Makefile.cloudlab

common_devstack:
	make -C ../common -f Makefile.devstack

common_opencloud:
	make -C ../common -f Makefile.opencloud

stop:
	sudo docker stop $(RUNNING_CONTAINER)

showlogs:
	sudo docker logs $(LAST_CONTAINER)

enter:
	sudo docker exec -t -i $(RUNNING_CONTAINER) bash

clean:
	/proj/xos-PG0/acb/cleanup.sh
	sudo docker stop $(docker ps -a -q)
	sudo docker rm $(docker ps -a -q)
	sudo docker rmi $(docker images -f "dangling=true" -q)
